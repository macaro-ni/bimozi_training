

<!--<div class="container">-->
<!--  <div class="row">-->

<div>

<!--railsの要素を入れたら描画できなくなったが、divで囲ったら解決した-->
    <h1 class="m-3">文字練習</h1>

    <!--canvasの背景設定時に追加-->
  <div class="border-top border-bottom col-md-4">


        <span id="sample-text">
        <% lines = @letter.name.split("\n") %>
        <!--改行している場合-->
        <% if lines.length > 1 %>
          <% lines.each do |line| %>
            <!--lineの長さが15文字以上か？-->
            <% if line.length >= 15 %>
              <% num = 0 %>
              <% while num <= line.length do %>
                <% letter15 = line[num, 15] %>
                <%= letter15 %>
                <br>
                <% num += 15 %>
              <% end %>
            <!--15文字未満の場合 -->
            <% else %>
              <%= line %>
              <br>
            <% end %>
          <% end %>
        <!--改行せずに15文字未満の文字列を入力した場合-->
        <% else %>
          <% if @letter.name.length >= 15 %>
            <% num = 0 %>
            <% while num <= @letter.name.length do %>
              <% letter15 = @letter.name[num, 15] %>
              <%= letter15 %>
              <br>
              <% num += 15 %>
            <% end %>
          <% else %>
            <%= @letter.name %>
            <br>
          <% end %>
        <% end %>
      </span>
  </div>

</div>

    <div>
        <input type="radio" id="draw" name="mode">
        <label for="draw">ペン</label>
        <!--<input type="radio" id="erase" name="mode">-->
        <!--<label for="draw">消しゴム</label>-->
        <!--<button onclick="canvas.clear().renderAll()", class: "btn btn-sm">全て削除</button>-->

        　<!--「data: {"turbolinks" => false} 」を入れることで背景は消えないようになった-->
        <%= link_to "一括削除" ,new_sample_practice_path(@letter.id), data: {"turbolinks" => false}, class: "btn" %>
    </div>

    <div>
        <% if current_user.email == 'guest@example.com' %>
          <p>[会員登録すると練習の記録ができます。]</p>
        <% else %>
          <input type="button" id="downloadPng" value="保存" class="btn btn-sm" >
        <% end %>
    </div>
    <br>

    <style>
      html, body {
        /*cursor: url(<%= asset_path 'cursor.png' %>), auto;*/
      }
    </style>

    <!-- お絵描きエリアの設定 -->
    <canvas id="canvas" height="500" width="1000" style="border-style: solid; border-color: black;"> </canvas>

    <!-- Fabric.jsの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <!--ペン機能-->
    <script>
    const canvas = new fabric.Canvas("canvas");

    document.getElementById("draw").addEventListener("click", function () {
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        canvas.freeDrawingCursor = 'url(<%= asset_path 'cursor.png' %>) 5 5 , auto';
        canvas.freeDrawingBrush.width=4;
        canvas.freeDrawingBrush.color="black";
        canvas.isDrawingMode = true;
        // canvas.freeDrawingCursor = 'url(<%= asset_path 'circle-2.cur' %>), default';
        // カーソルを変えたかったがわからず
        // canvas.freeDrawingCursor = 'url(<%= asset_path 'circle-2.cur' %>), default';
        // console.log(canvas.freeDrawingCursor)
    });

    // 消しゴム機能
        // canvas.backgroundColor="white";

    // document.getElementById("erase").addEventListener("click", function () {
    //   canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
    //   canvas.freeDrawingBrush.width=10;
    //   canvas.freeDrawingBrush.color="white";
    //   canvas.isDrawingMode = true;
    // });

    // canvas背景に枠線画像追加（ここから）
        // 画像を読み込むためのImageオブジェクトを作成
    const backgroundImage = new Image();
        // Fabric.jsのloadFromJSONメソッドを呼び出して、キャンバス上に背景画像を設定
    backgroundImage.onload = function() {
    canvas.setBackgroundImage(backgroundImage.src, canvas.renderAll.bind(canvas), {
      //( scaleX と scaleY に元画像のサイズとキャンバスのサイズの比率をかけることで、適切なサイズに変更できる。)
      // (left と top の値を変更することで、画像をずらすことができる。)
      top: 0,
      left: 0,
      scaleX: canvas.width / backgroundImage.width * 1.0,
      scaleY: canvas.height / backgroundImage.height * 1.0

      });
    };
        // 画像を読み込み
    backgroundImage.src = "<%= asset_path('sampleflame.jpg')%>";//"https://drive.google.com/uc?export=view&id=1WWSMI2uAnp8jZgGb4J-ZDDTabsUYHZNI";
    // canvas背景に枠線画像追加（ここまで）




    // テキストを取得して、canvasに描画する
    const text = document.getElementById("sample-text").innerText;
    const textObject = new fabric.Text(text, {
      left: 50,
      top: 20,
      fill: "#dcdcdc",
      fontFamily: "Klee One",
      fontSize: 60,

    });
    canvas.add(textObject);




// ダウンロード
document.getElementById("downloadPng").addEventListener("click", function () {
   const base64 = canvas.toDataURL({
       format: "png",
   });

    document.getElementById("newImg").value = base64;


    $.ajax({
      url: "https://086192e85b094c90b02448a4e1eca7d4.vfs.cloud9.ap-northeast-1.amazonaws.com/letters/<%= @letter.id %>/post_image",  // リクエストを送信するURLを指定
      type: "POST",  // HTTPメソッドを指定（デフォルトはGET）
      data: {  // 送信するデータをハッシュ形式で指定
        image: {body: base64}
      },
      dataType: "json"  // レスポンスデータをjson形式と指定する
    })
    .done(function(data) {
      window.location.href = "https://086192e85b094c90b02448a4e1eca7d4.vfs.cloud9.ap-northeast-1.amazonaws.com/practices";
       // textareaを空にする
    })
    .fail(function() {
      alert("error!");  // 通信に失敗した場合はアラートを表示
    })
    .always(function() {

    });
    //// .done：処理に成功した時（practice/indexぺージに遷移する）。.fail:処理に失敗した時（アラート表示）。.always:done,failの後にいつも行われるもの（特になし）。

});


  // 画像保存機能
      function chgImg()
    {
      var png = cvs.toDataURL();
      byebug
      document.getElementById("newImg").src = png;
    }

    </script>
    <textarea id="newImg" class="hidden_area"></textarea>



<!--  </div>-->
<!--</div>-->
